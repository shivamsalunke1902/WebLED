<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgroMind Storage Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>
</head>
<body class="bg-gradient-to-br from-green-50 to-green-100 min-h-screen flex flex-col">
  <header class="p-4 bg-green-700 text-white text-center shadow-lg">
    <h1 class="text-2xl font-bold">🌱 AgroMind Storage Management</h1>
  </header>

  <main class="flex-1 p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- Temperature & Humidity Card -->
    <div class="bg-white p-6 rounded-2xl shadow-lg flex flex-col items-center">
      <h2 class="text-lg font-semibold mb-2">🌡️ Temperature</h2>
      <p id="temp" class="text-3xl font-bold text-green-700">-- °C</p>
      <h2 class="text-lg font-semibold mt-4 mb-2">💧 Humidity</h2>
      <p id="hum" class="text-3xl font-bold text-green-700">-- %</p>
    </div>

    <!-- Crop & Shelf Life -->
    <div class="bg-white p-6 rounded-2xl shadow-lg flex flex-col items-center">
      <h2 class="text-lg font-semibold mb-2">🌾 Crop in Storage</h2>
      <p id="crop" class="text-2xl font-bold">--</p>
      <h2 class="text-lg font-semibold mt-4 mb-2">⏳ Shelf Life</h2>
      <p id="shelfLife" class="text-xl font-bold text-yellow-600">-- days</p>
    </div>

    <!-- Alerts -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <h2 class="text-lg font-semibold mb-4">⚠️ Alerts</h2>
      <div id="alerts" class="space-y-2 text-sm">
        <p class="text-gray-500">No alerts yet...</p>
      </div>
    </div>

    <!-- Live Chart -->
    <div class="bg-white p-6 rounded-2xl shadow-lg col-span-1 md:col-span-2">
      <h2 class="text-lg font-semibold mb-4">📊 Real-Time Temperature & Humidity</h2>
      <canvas id="liveChart" class="w-full h-64"></canvas>
    </div>

    <!-- Market Prices -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
      <h2 class="text-lg font-semibold mb-4">💹 Market Price Tracker</h2>
      <p class="text-2xl font-bold text-green-700" id="marketPrice">₹ -- /kg</p>
    </div>

    <!-- Controls -->
    <div class="bg-white p-6 rounded-2xl shadow-lg flex flex-col items-center">
      <h2 class="text-lg font-semibold mb-4">💡 LED Control</h2>
      <button onclick="toggleLED()" class="px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700">Toggle LED</button>
      <p id="ledState" class="mt-4 text-gray-600">LED Status: Unknown</p>
    </div>
  </main>

  <footer class="p-4 bg-green-700 text-white text-center">
    <p class="text-sm">AgroMind © 2025 | Smart Farming for All</p>
  </footer>

  <script>
    // MQTT Setup
    const BROKER = "broker.hivemq.com";
    const WSS_PORT = 8884;
    const MQTT_PATH = "/mqtt";
    const CLIENT_ID = "web_" + Math.random().toString(16).substr(2, 8);

    const TOPIC_DHT = "esp32/dht";
    const TOPIC_MARKET = "esp32/market";
    const TOPIC_LED = "esp32/led";
    const TOPIC_BUTTON = "esp32/button";

    let client;

    function connectMQTT() {
      client = new Paho.MQTT.Client(BROKER, WSS_PORT, MQTT_PATH, CLIENT_ID);
      client.onConnectionLost = (response) => console.log("Connection lost", response);
      client.onMessageArrived = onMessageArrived;

      client.connect({
        useSSL: true,
        onSuccess: () => {
          console.log("Connected to MQTT");
          client.subscribe(TOPIC_DHT);
          client.subscribe(TOPIC_MARKET);
          client.subscribe(TOPIC_LED);
        },
        onFailure: (err) => console.error("MQTT Connection failed", err)
      });
    }

    // Handle incoming messages
    function onMessageArrived(message) {
      try {
        if (message.destinationName === TOPIC_DHT) {
          const data = JSON.parse(message.payloadString);
          document.getElementById("temp").textContent = data.temp + " °C";
          document.getElementById("hum").textContent = data.hum + " %";
          document.getElementById("crop").textContent = data.crop;
          document.getElementById("shelfLife").textContent = data.shelfLife + " days";
          updateChart(data.temp, data.hum);
        }
        if (message.destinationName === TOPIC_MARKET) {
          document.getElementById("marketPrice").textContent = "₹ " + message.payloadString + " /kg";
        }
        if (message.destinationName === TOPIC_LED) {
          document.getElementById("ledState").textContent = "LED Status: " + message.payloadString;
        }
      } catch (err) {
        console.error("Message handling error", err);
      }
    }

    // LED Control
    function toggleLED() {
      const msg = new Paho.MQTT.Message("TOGGLE");
      msg.destinationName = TOPIC_BUTTON;
      client.send(msg);
    }

    // Chart.js Setup
    const ctx = document.getElementById("liveChart").getContext("2d");
    const liveChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          { label: "Temperature (°C)", data: [], borderColor: "#16a34a", fill: false },
          { label: "Humidity (%)", data: [], borderColor: "#0284c7", fill: false }
        ]
      },
      options: { responsive: true, scales: { x: { display: false } } }
    });

    function updateChart(temp, hum) {
      const maxPoints = 10;
      liveChart.data.labels.push("");
      liveChart.data.datasets[0].data.push(temp);
      liveChart.data.datasets[1].data.push(hum);
      if (liveChart.data.labels.length > maxPoints) {
        liveChart.data.labels.shift();
        liveChart.data.datasets[0].data.shift();
        liveChart.data.datasets[1].data.shift();
      }
      liveChart.update();
    }

    // Initialize
    connectMQTT();
  </script>
</body>
</html>
